<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Êõ≤„É™„Çπ„ÉàÔΩúÁ∑ë‰ªôÈùûÂÖ¨Âºè„Éï„Ç°„É≥„Çµ„Ç§„Éà</title>
  <link rel="icon" href="../images/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="../images/Nagao-icon.png" sizes="512x512">
  <link rel="apple-touch-icon" href="../images/Nagao-icon.png">
  <link rel="canonical" href="https://oukasui.com/song/">

  <meta property="og:site_name" content="„Åó„Åá„Çì„Åó„Åá„ÇìÔΩúÁ∑ë‰ªôÈùûÂÖ¨Âºè„Éï„Ç°„É≥„Çµ„Ç§„Éà„ÄÄÊõ≤Ê§úÁ¥¢">
  <meta property="og:type" content="website">
  <meta property="og:title" content="„Åó„Åá„Çì„Åó„Åá„ÇìÔΩúÁ∑ë‰ªôÈùûÂÖ¨Âºè„Éï„Ç°„É≥„Çµ„Ç§„Éà„ÄÄÊõ≤Ê§úÁ¥¢">
  <meta property="og:description" content="Á∑ë‰ªô„ÅÆÊõ≤„Ç¢„Éº„Ç´„Ç§„Éñ„ÇíÊ®™Êñ≠Ê§úÁ¥¢„ÄÇÊõ≤Âêç„Éª„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà„ÉªÂãïÁîª„Çø„Ç§„Éà„É´„Éª„Çø„Ç∞„Åã„ÇâÁ¥†Êó©„ÅèÊé¢„Åõ„Åæ„Åô„ÄÇ">
  <meta property="og:url" content="https://github.com/keihanmatcha/shen">
  <meta property="og:image" content="https://github.com/keihanmatcha/shen/images/ogp.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="„Åó„Åá„Çì„Åó„Åá„ÇìÔΩúÁ∑ë‰ªôÈùûÂÖ¨Âºè„Éï„Ç°„É≥„Çµ„Ç§„Éà„ÄÄÊõ≤Ê§úÁ¥¢">
  <meta name="twitter:description" content="Á∑ë‰ªô„ÅÆÊõ≤„Ç¢„Éº„Ç´„Ç§„Éñ„ÇíÊ®™Êñ≠Ê§úÁ¥¢„ÄÇÊõ≤Âêç„Éª„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà„ÉªÂãïÁîª„Çø„Ç§„Éà„É´„Éª„Çø„Ç∞„Åã„ÇâÁ¥†Êó©„ÅèÊé¢„Åõ„Åæ„Åô„ÄÇ">
  <meta name="twitter:image" content="https://github.com/keihanmatcha/shen/images/ogp.png">

  <style>
    /* ===== Âü∫Êú¨„Çπ„Çø„Ç§„É´ ===== */
    *, *::before, *::after { box-sizing: border-box; }

    :root{ --fg:#222; --muted:#4b5563; --accent:#009297; --bg:#fff; --border:#e5e7eb; --panel:#f8f8ff; }
    
    html, body {
        margin: 0; padding: 0;
        background: var(--bg); color: var(--fg);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
        width: 100%; max-width: 100%;
    }
    
    /* ===== „Éò„ÉÉ„ÉÄ„Éº ===== */
    header {
        position: sticky; top: 0;
        background: linear-gradient(90deg, #009297, #5DCCAB);
        backdrop-filter: saturate(1.2) blur(6px);
        border-bottom: 1px solid var(--border);
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    header .wrap {
        max-width: 1200px; margin-inline: auto; padding: 12px 16px;
        display: flex; flex-direction: column; gap: 12px;
    }

    /* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
    .nav-header { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 32px; }
    .brand { font-weight: 800; color: #fff; text-decoration: none; font-size: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .nav-links { display: flex; gap: 10px; }
    .nav-links a { 
        position: relative; font-size: 13px; font-weight: 700; color: #fff; text-decoration: none; 
        padding: 6px 14px; margin-left: 0; z-index: 1; transition: transform 0.2s;
    }
    .nav-links a::before {
        content: ""; position: absolute; inset: 0; z-index: -1;
        transform: skewX(-20deg); border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: opacity 0.2s, transform 0.2s;
    }
    .nav-links a.link-video::before { background: #B43246; }
    .nav-links a:hover { transform: translateY(-2px); }
    .nav-links a:hover::before { opacity: 0.9; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

    /* Ê§úÁ¥¢„ÉÑ„Éº„É´„Éê„Éº */
    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; width: 100%; }
    .searchbar { display: flex; gap: 8px; align-items: center; flex: 1; min-width: 280px; }
    .searchbar input {
        flex: 1; padding: 10px 14px; border: 0; border-radius: 10px; font-size: 16px;
        background: rgba(255, 255, 255, 0.95); box-shadow: 0 2px 6px rgba(0,0,0,0.05); color: #333;
        min-width: 0;
    }
    .searchbar input:focus { outline: 2px solid #fff; background: #fff; }

    /* „Éï„Ç£„É´„Çø„Éê„Éº */
    .filterbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .filter-tags { display:flex; gap:8px; flex-wrap:wrap; }
    
    .chip-tag {
        font-size: 12px; line-height: 1; padding: 8px 12px; border: 0; border-radius: 999px;
        background: rgba(255, 255, 255, 0.85); color: var(--accent); cursor: pointer; font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: .15s;
    }
    .chip-tag:hover { background: #fff; transform: translateY(-1px); }
    .chip-tag.active { background: var(--accent); color: #fff; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
    
    .chip-clear {
        font-size: 12px; padding: 6px 12px; border: 1px solid rgba(255,255,255,0.6); border-radius: 999px; 
        background: transparent; color: #fff; cursor: pointer;
    }
    .chip-clear:hover { background: rgba(255,255,255,0.1); }

    /* „É¨„Ç§„Ç¢„Ç¶„Éà */
    .grid{display:grid;gap:16px;align-items:start;grid-template-columns:1.2fr .8fr;grid-template-areas:"list player"}
    .grid.player-left{grid-template-columns:.8fr 1.2fr;grid-template-areas:"player list"}

    /* „É™„Çπ„Éà */
    .list{border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row {
      display: grid; grid-template-columns: minmax(260px,1.5fr) auto 120px minmax(0,2fr);
      align-items: center; gap: 12px; padding: 10px 14px;
      border-top: 1px solid var(--border); background: #fafafa; cursor: pointer;
    }
    .row:nth-child(odd){background:#f6f6fb}
    .row:first-child{border-top:none}
    
    .songcell{display:flex;flex-direction:column}
    .song-meta { display: flex; align-items: center; gap: 8px; }
    .songtitle{ font-weight:600; display:flex; gap:8px; align-items:center }
    .artist{font-size:12px;color:var(--muted)}
    
    .link { all: unset; cursor: pointer; color: inherit; }
    .link:hover { color: var(--accent); text-decoration: underline; }
    .link.artist { color: var(--muted); }
    
    .favorite-btn { all: unset; cursor: pointer; padding: 0; margin: 0; }
    .star-icon { font-size: 20px; color: #ccc; transition: color 0.2s ease; }
    .favorite-btn.is-favorited .star-icon { color: #ffd700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
    
    .date{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1;color:#374151;justify-self:end;text-align:right;width:120px}
    .videotitle{display:flex;flex-direction:column;gap:8px}
    .videotitle button{all:unset;cursor:pointer;color:#111}
    .videotitle button:hover{color:var(--accent);text-decoration:underline}
    .ellipsis{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* „Çø„Ç∞ */
    .tags-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:2px; padding-top:6px; border-top:1px dashed var(--border); }
    .tags-row::before{ content:"„Çø„Ç∞"; font-size:11px; color:var(--muted); margin-right:4px; padding:2px 6px; border:1px solid var(--border); border-radius:999px; background:#fff; }
    .tag-badge { appearance:none; border:0; cursor:pointer; font-size:12px; line-height:1; padding:8px 12px; border-radius:999px; background:#f2efff; color:#4c46a6; border:1px solid #e5dfff; display:inline-flex; gap:6px; align-items:center; }
    .tag-badge:hover { filter: brightness(.97); }
    .tag-badge.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    .nothing{color:var(--muted);text-align:center;padding:20px;border:1px dashed var(--border);border-radius:12px}

    /* „Éó„É¨„Ç§„É§„Éº */
    .player-panel{ position:sticky;top:84px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:var(--panel) }
    .player-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#f0f1ff;border-bottom:1px solid var(--border)}
    #closePlayerBtn { display: none; font-size: 24px; cursor: pointer; line-height: 1; padding: 0 8px; }
    .player-title{font-size:14px;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; max-width: 200px;}
    .player-sub{font-size:12px;color:var(--muted)}
    .player-body{position:relative;aspect-ratio:16/9;width:100%;background:#000}
    .player-body iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .player-foot{padding:10px 14px;border-top:1px solid var(--border);background:#fff}
    .setlist{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:8px}
    .set-item{display:flex;justify-content:space-between;gap:12px;padding:10px 12px;border-top:1px solid var(--border);background:#fafafa;cursor:pointer}
    .set-item:hover{background:#f3f4ff}
    .set-item.active{background:#e9ecff}
    .set-title{display:flex;flex-direction:column}
    .set-song{font-weight:600}
    .set-artist{font-size:12px;color:var(--muted)}
    .set-time{font-variant-numeric:tabular-nums;color:#374151;white-space:nowrap}
    .warn{margin-top:8px;padding:10px 12px;color:#92400e;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px}

    .list-col{grid-area:list}
    .player-col{grid-area:player}

    @media (min-width: 901px){
      .player-col{ position: sticky; top: 140px; align-self:start; height: fit-content; z-index: 5; }
      .player-panel{ position: static; }
    }

    /* „Çπ„Éû„ÉõÂØæÂøú */
    @media (max-width: 900px) {
        .grid { display: block; }
        .list-col, .list { width: 100%; padding: 0; }
        header .wrap { padding: 10px 12px; gap: 8px; }
        .brand { font-size: 18px; }
        .nav-links a { padding: 4px 10px; font-size: 11px; }
        .searchbar input { font-size: 14px; padding: 8px 10px; }
        .chip-tag { padding: 6px 10px; font-size: 11px; }
        
        .row{ grid-template-columns:1fr; align-items:start; gap: 8px; }
        .date{ justify-self:start; font-size: 11px; color: #888; margin-bottom: 2px; }
        .videotitle{ margin-top: -4px; }
        .videotitle button { font-size: 11px; color: #6b7280; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .player-col { display: none; }

        body.player-active { overflow: hidden; }
        body.player-active header, body.player-active .list-col { display: none !important; }
        
        body.player-active .player-col {
            display: flex !important; position: fixed; top: 0; left: 0; z-index: 9999;
            width: 100%; height: 100vh; background: rgba(0, 0, 0, 0.85);
            align-items: center; justify-content: center;
        }
        body.player-active .player-panel {
            position: relative; top: auto; width: 95%; max-width: 600px; max-height: 90vh;
            background: #fff; border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #closePlayerBtn { display: block; }
        .player-head { padding: 12px; }
        .player-foot { overflow-y: auto; flex: 1; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="nav-header">
        <a href="../index.html" class="brand">„Åó„Åá„Çì„Åó„Åá„Çì</a>
        <nav class="nav-links">
          <a href="../archives/index.html" class="link-video">ÂãïÁîª„ÇíÊé¢„Åô</a>
        </nav>
      </div>
      <div class="toolbar">
        <div class="searchbar">
            <input id="q" type="search" placeholder="Êõ≤Âêç„Éª„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà„ÉªÂãïÁîª„Çø„Ç§„Éà„É´„Éª„Çø„Ç∞„ÅßÊ§úÁ¥¢" autocomplete="off" />
        </div>
        <div class="filterbar">
          <div id="filterTags" class="filter-tags"></div>
          <button id="filterFavorites" class="chip-tag" type="button" style="display:none">‚òÖ „ÅäÊ∞ó„Å´ÂÖ•„Çä</button>
          <button id="clearTags" class="chip-clear" type="button" style="display:none">„Éï„Ç£„É´„Çø„ÉºËß£Èô§</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="grid" class="grid player-left">
      <section class="list-col">
        <div id="list" class="list"></div>
        <div id="empty" class="nothing" style="display:none">Ë©≤ÂΩì„Åô„ÇãÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
      </section>
      
      <aside class="player-col">
        <div class="player-panel" id="playerPanel">
          <div class="player-head">
            <span class="drag-handle" style="font-weight:700;opacity:.5;padding:0 6px;" aria-hidden="true">‚â°</span>
            <div style="flex:1; overflow:hidden; padding:0 10px;">
              <div class="player-title" id="playerTitle">ÔºàÂãïÁîª„Çø„Ç§„Éà„É´Ôºâ</div>
              <div class="player-sub" id="playerMeta">YYYY.MM.DD / „ÉÅ„É£„É≥„Éç„É´Âêç</div>
            </div>
            <div id="closePlayerBtn">‚úï</div>
            <div style="display:flex;gap:8px;align-items:center" class="pc-only-link">
               <a id="openYT" href="#" target="_blank" rel="noopener" style="font-size:12px;color:var(--accent);text-decoration:none;white-space:nowrap;">YouTube„ÅßÈñã„Åè ‚Üó</a>
            </div>
          </div>
          <div class="player-body"><iframe id="ytFrame" src="about:blank" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe></div>
          <div class="player-foot">
            <div class="meta-line"><strong>„Çª„ÉÉ„Éà„É™„Çπ„Éà</strong></div>
            <div class="setlist" id="setlist"></div>
            <div id="embedWarn" class="warn" style="display:none">„Åì„ÅÆÂãïÁîª„ÅØ„Éö„Éº„Ç∏ÂÜÖÂÜçÁîü„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<a id="warnLink" href="#" target="_blank" rel="noopener">YouTube„ÅßÈñã„Åè</a> „Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    const $list = document.getElementById('list');
    const $empty = document.getElementById('empty');
    const $q = document.getElementById('q');
    const $filterTags = document.getElementById('filterTags');
    const $clearTags = document.getElementById('clearTags');
    const $filterFavorites = document.getElementById('filterFavorites');
    
    // Â§âÊï∞
    let filterByFavorites = false;
    // „Ç´„ÉÜ„Ç¥„É™Â∞ÇÁî®Â§âÊï∞„ÅØÂâäÈô§Ôºà„Çø„Ç∞„Å´Áµ±Âêà„Åô„Çã„Åü„ÇÅÔºâ

    const $panel = document.getElementById('playerPanel');
    const $yt = document.getElementById('ytFrame');
    const $title = document.getElementById('playerTitle');
    const $meta = document.getElementById('playerMeta');
    const $open = document.getElementById('openYT');
    const $warn = document.getElementById('embedWarn');
    const $warnLink = document.getElementById('warnLink');
    const $setlist = document.getElementById('setlist');
    const $closeBtn = document.getElementById('closePlayerBtn');

    const pad = n => String(n).padStart(2,'0');
    const ymdToDots = ymd => { const [y,m,d] = (ymd||'').split('-'); return y?`${y}.${pad(m)}.${pad(d)}`:''; };

    const FAVORITES_KEY = 'favorites';
    function fillSearch(text){ if(!text) return; $q.value=text; applyFilter(); }

    function toSeconds(v){
      if(v==null) return 0;
      if (typeof v === 'number') return Math.max(0, v|0);
      if (/^\d+$/.test(v)) return Math.max(0, parseInt(v,10));
      const p = String(v).split(':').map(Number);
      if (p.length===3) return p[0]*3600 + p[1]*60 + p[2];
      if (p.length===2) return p[0]*60 + p[1];
      return 0;
    }
    const hms = sec => { sec=toSeconds(sec); const h=Math.floor(sec/3600), m=Math.floor(sec%3600/60), s=Math.floor(sec%60); return `${pad(h)}:${pad(m)}:${pad(s)}`; };

    let player=null, apiReady=false;
    window.onYouTubeIframeAPIReady = ()=>{ apiReady = true; };
    
    function loadVideo(id, start=0){
      $warn.style.display='none';
      const startSec = toSeconds(start);
      const url = `https://www.youtube.com/embed/${id}?start=${startSec}&autoplay=1&rel=0&modestbranding=1&playsinline=1&enablejsapi=1`;

      if(apiReady){
        if(!player){
          player = new YT.Player('ytFrame', {
            playerVars:{rel:0,modestbranding:1,playsinline:1},
            events:{ onError:()=>($warn.style.display='block') }
          });
        }
        try{
          player.loadVideoById({videoId:id, startSeconds:startSec});
          return;
        }catch(e){}
      }
      $yt.src = url;
    }

    function normalizeVideos(videos){
      const map = new Map();
      for(const raw of videos){
        const v = {...raw};
        const id = v.youtubeId;
        const songs = (v.songs || v.setlist || []).map(s=>({
          title: s.title || s.song || '',
          artist: s.artist || s.singer || 'Ôºà‰∏çÊòéÔºâ',
          start: toSeconds(s.start ?? s.time ?? s.begin ?? 0)
        }));
        const tags = Array.isArray(v.tags) ? v.tags.filter(Boolean) : [];
        if(!map.has(id)){
          map.set(id, { title: v.title||'', date: v.date||'', channel: v.channel||'', youtubeId: id||'', songs: [], tags: [] });
        }
        const bucket = map.get(id);
        for(const s of songs){ const key = `${s.title}__${s.artist}__${s.start}`; if(!bucket.songs.some(t => `${t.title}__${t.artist}__${t.start}`===key)) bucket.songs.push(s); }
        bucket.tags = Array.from(new Set([...(bucket.tags||[]), ...tags]));
      }
      for(const v of map.values()){ v.songs.sort((a,b)=> a.start - b.start); }
      return [...map.values()];
    }

    let ALL_ROWS=[]; let VIDEO_MAP=new Map(); let ALL_TAGS=[]; const SELECTED_TAGS=new Set();
    
    // === buildRowsÈñ¢Êï∞ÔºàËá™ÂãïÂà§ÂÆö„Çí„Çø„Ç∞„Å´Áµ±ÂêàÔºâ ===
    function buildRows(videos){
      const merged = normalizeVideos(videos);
      VIDEO_MAP = new Map(merged.map(v => [v.youtubeId, v]));
      ALL_ROWS = [];
      
      for(const v of merged){
        // Âà§ÂÆöÁî®ÊñáÂ≠óÂàó
        const checkStr = ((v.tags||[]).join(' ') + ' ' + v.title).toLowerCase();
        
        // Âà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ
        let isDance = /Ë∏ä|„ÉÄ„É≥„Çπ|dance|choreography|ÊåØ‰ªò|motion/.test(checkStr);
        let isPlay  = /Âºæ|Ê•ΩÂô®|„Éô„Éº„Çπ|„ÇÆ„Çø„Éº|„Éâ„É©„É†|„Éî„Ç¢„Éé|ÊºîÂ•è|Âè©|session|inst/.test(checkStr);
        let isSong = /Ê≠å|song|cover|mv|original|vocal|„Ç´„É©„Ç™„Ç±|„Ç¢„Ç´„Éö„É©|chorus/.test(checkStr);

        // „ÄåÂºæ„ÅçË™û„Çä„Äç„ÅØÊ≠å„Å®Âºæ„Åè„ÅÆ‰∏°Êñπ
        if (/Âºæ„ÅçË™û„Çä/.test(checkStr)) {
            isPlay = true; isSong = true;
        }

        // ÊïëÊ∏àÊé™ÁΩÆ
        if (!isDance && !isPlay && !isSong) {
            isSong = true;
        }

        // ‚òÖ‰øÆÊ≠£ÁÇπÔºöÂà§ÂÆöÁµêÊûú„Çí„Äå„Çø„Ç∞„Äç„Å®„Åó„Å¶ÈÖçÂàó„Å´ËøΩÂä†ÔºàSet„ÅßÈáçË§áÊéíÈô§Ôºâ
        const tagsSet = new Set(v.tags || []);
        if(isSong) tagsSet.add('Ê≠å');
        if(isDance) tagsSet.add('Ë∏ä');
        if(isPlay) tagsSet.add('Âºæ');
        
        // Êõ¥Êñ∞„Åó„Åü„Çø„Ç∞„É™„Çπ„Éà„Çí‰øùÂ≠ò
        const finalTags = Array.from(tagsSet);
        v.tags = finalTags; // „Éì„Éá„Ç™„Éá„Éº„ÇøËá™‰Ωì„ÇÇÊõ¥Êñ∞

        for(const s of v.songs){
           ALL_ROWS.push({ 
             song:s.title, artist:s.artist, date:v.date, videoTitle:v.title, 
             youtubeId:v.youtubeId, start:s.start, 
             tags: finalTags, 
             tagsText: finalTags.join(' ')
           });
        }
      }
      ALL_ROWS.sort((a,b)=>{ if(a.date!==b.date) return a.date<b.date?1:-1; const s=a.song.localeCompare(b.song,'ja'); if(s) return s; return a.artist.localeCompare(b.artist,'ja'); });
      // „Åô„Åπ„Å¶„ÅÆ„Çø„Ç∞„ÇíÂèéÈõÜÔºàËá™ÂãïËøΩÂä†„Åï„Çå„Åü„ÄåÊ≠å„Äç„ÄåË∏ä„Äç„ÄåÂºæ„Äç„ÇÇ„Åì„Åì„Å´Âê´„Åæ„Çå„ÇãÔºâ
      ALL_TAGS = Array.from(new Set(merged.flatMap(v => v.tags||[]))).sort((a,b)=>a.localeCompare(b,'ja'));
      renderFilterTags();
    }

    function getFavorites() {
      const favorites = localStorage.getItem(FAVORITES_KEY);
      return favorites ? JSON.parse(favorites) : [];
    }
    function saveFavorites(favorites) {
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
    }

    function renderFilterTags(){
      const favorites = getFavorites();
      $filterFavorites.style.display = favorites.length > 0 ? '' : 'none';
      $filterFavorites.classList.toggle('active', filterByFavorites);
      $filterTags.innerHTML='';
      if(!ALL_TAGS.length && favorites.length === 0){ $filterTags.parentElement.style.display='none'; $clearTags.style.display='none'; return; }
      $filterTags.parentElement.style.display='';
      for(const t of ALL_TAGS){
        const b=document.createElement('button');
        b.className='chip-tag'+(SELECTED_TAGS.has(t)?' active':'');
        b.type='button'; b.textContent=t;
        b.addEventListener('click', ()=>{filterByFavorites = false; if(SELECTED_TAGS.has(t)) SELECTED_TAGS.delete(t); else SELECTED_TAGS.add(t); renderFilterTags(); applyFilter(); });
        $filterTags.appendChild(b);
      }
      $clearTags.style.display = (SELECTED_TAGS.size > 0 || filterByFavorites) ? 'inline-block' : 'none';
    }
    $clearTags.addEventListener('click', ()=>{ SELECTED_TAGS.clear(); filterByFavorites = false; renderFilterTags(); applyFilter(); });

    function renderRows(rows){
      $list.innerHTML='';
      if(!rows.length){ $empty.style.display='block'; return; }
      $empty.style.display='none';
      
      const displayRows = rows;
      
      for(const r of displayRows){
        const songKey = `${r.youtubeId}-${r.start}`;
        const div=document.createElement('div');
        div.className='row';
        div.innerHTML=`
          <div class="songcell">
            <div class="song-meta">
              <span class="note">üéµ</span>
              <button class="link song" type="button">${r.song}</button>
              <button class="favorite-btn" aria-label="„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†/ÂâäÈô§">
                <span class="star-icon">‚òÜ</span>
              </button>
            </div>
            <div class="artist ellipsis">
              <button class="link artist" type="button">${r.artist}</button>
            </div>
          </div>
          <div class="date">${ymdToDots(r.date)}</div>
          <div class="videotitle">
            <div class="ellipsis">
              <button type="button" class="videolink">${simplifyTitle(r.videoTitle)}</button>
            </div>
            <div class="tags-row"></div>
          </div>`;

        const favBtn = div.querySelector('.favorite-btn');
        if (getFavorites().includes(songKey)) {
            favBtn.classList.add('is-favorited');
        }
        favBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const currentFavorites = getFavorites();
            const index = currentFavorites.indexOf(songKey);
            if (index > -1) {
                currentFavorites.splice(index, 1);
                favBtn.classList.remove('is-favorited');
            } else {
                currentFavorites.push(songKey);
                favBtn.classList.add('is-favorited');
            }
            saveFavorites(currentFavorites);
            if (filterByFavorites) applyFilter();
        });

        div.querySelector('.song').addEventListener('click', (e)=> { e.stopPropagation(); fillSearch(r.song); });
        div.querySelector('.link.artist').addEventListener('click', (e)=> { e.stopPropagation(); fillSearch(r.artist); });
        
        const rowTagBox = div.querySelector('.tags-row');
        // Ë°®Á§∫Áî®„Å´„Çø„Ç∞„ÇíÂèñÂæóÔºàËá™ÂãïÂà§ÂÆö„Çø„Ç∞„ÇÇÂê´„ÇÄÔºâ
        const tags = r.tags || [];
        if (tags.length > 0) {
          const t = tags[0];
          const b = document.createElement('button');
          b.className = 'tag-badge';
          b.type = 'button';
          b.textContent = t;
          b.addEventListener('click', (e) => { e.stopPropagation(); fillSearch(t); });
          rowTagBox.appendChild(b);
        }
        
        const playHandler = (e) => {
           const isButton = e.target.closest('.song, .link.artist, .favorite-btn, .tag-badge');
           if(isButton) return;

           const id = r.youtubeId;
           const start = r.start || 0;
           const video = VIDEO_MAP.get(id) || { songs: [], tags: [] };
           
           $title.textContent = `${r.videoTitle}${start ? `Ôºà${hms(start)}„ÄúÔºâ` : ''}`;
           $meta.textContent = `${ymdToDots(r.date)} / ${video.channel || ''}`;
           $open.href = `https://www.youtube.com/watch?v=${id}&t=${toSeconds(start)}s`;
           $warnLink.href = $open.href;
           
           renderSetlist(video, id, toSeconds(start));
           loadVideo(id, start);
           
           if (window.innerWidth <= 900) {
               document.body.classList.add('player-active');
           } else {
               $panel.style.display = 'block';
               $panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
           }
        };

        div.addEventListener('click', playHandler);
        div.querySelector('.videolink').addEventListener('click', playHandler);

        $list.appendChild(div);
      }
    }

    function simplifyTitle(t) {
      return t.replace(/„Äê.*?„Äë|\[.*?\]/g, '').trim() || t;
    }

    function renderSetlist(video, id, activeStart){
      $setlist.innerHTML='';
      for(const s of (video.songs||[])){
        const sec = toSeconds(s.start);
        const item=document.createElement('div');
        item.className='set-item'+(sec===activeStart?' active':'');
        item.innerHTML=`<div class="set-title"><div class="set-song">${s.title}</div><div class="set-artist">${s.artist}</div></div><div class="set-time">${hms(sec)}„Äú</div>`;
        item.addEventListener('click', ()=>{
          loadVideo(id, sec);
          $title.textContent = `${video.title}Ôºà${hms(sec)}„ÄúÔºâ`;
          $open.href = `https://www.youtube.com/watch?v=${id}&t=${sec}s`;
          [...$setlist.children].forEach(el=>el.classList.remove('active'));
          item.classList.add('active');
        });
        $setlist.appendChild(item);
      }
    }

    // === „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Âá¶ÁêÜÔºà‰øÆÊ≠£Ôºö„Çø„Ç∞„Éï„Ç£„É´„Çø„ÅÆ„Åø„Å´ÂçòÁ¥îÂåñÔºâ ===
    function applyFilter() {
      let filteredRows = ALL_ROWS;

      // 1. „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éï„Ç£„É´„Çø
      if (filterByFavorites) {
          const favorites = getFavorites();
          filteredRows = filteredRows.filter(r => favorites.includes(`${r.youtubeId}-${r.start}`));
      } 
      // 2. „Ç≠„Éº„ÉØ„Éº„ÉâÔºÜ„Çø„Ç∞„Éï„Ç£„É´„Çø
      else {
          const q = ($q.value || '').trim().toLowerCase();
          const selected = [...SELECTED_TAGS];
          
          filteredRows = filteredRows.filter(r => {
              const artistHit = r.artist.toLowerCase().includes(q);
              
              const textOk = !q || 
                  r.song.toLowerCase().includes(q) || 
                  artistHit || 
                  r.videoTitle.toLowerCase().includes(q) || 
                  (r.tagsText || '').toLowerCase().includes(q);
                  
              const tagOk = !selected.length || selected.every(t => (r.tags || []).includes(t));
              return textOk && tagOk;
          });
      }
      renderRows(filteredRows);
    }

    fetch('videos.json')
      .then(r=>r.json())
      .then(videos=>{ buildRows(videos); applyFilter(); })
      .catch(err=>{ console.error(err); $empty.style.display='block'; $empty.textContent='videos.json „ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'; });

    $q.addEventListener('input', applyFilter);
    $filterFavorites.addEventListener('click', () => {
      filterByFavorites = !filterByFavorites;
      if (filterByFavorites) SELECTED_TAGS.clear();
      renderFilterTags();
      applyFilter();
    });

    $closeBtn.onclick = () => {
       document.body.classList.remove('player-active');
       if(player && player.stopVideo) player.stopVideo();
       else $yt.src = 'about:blank';
    };

    (function () {
      const params = new URLSearchParams(location.search);
      const initialQ = (params.get("q") || "").trim();
      if (!initialQ) return;
      
      const interval = setInterval(() => {
          if (ALL_ROWS.length > 0) {
              clearInterval(interval);
              $q.value = initialQ;
              applyFilter();
              try {
                  const url = new URL(location.href);
                  url.searchParams.delete("q");
                  history.replaceState(null, "", url);
              } catch (_) {}
          }
      }, 100);
    })();
  </script>
</body>
</html>

